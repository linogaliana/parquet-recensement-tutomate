[
  {
    "objectID": "tuto/r.html",
    "href": "tuto/r.html",
    "title": "Utilisation du format Parquet avec  illustr√© √† partir de quelques exemples",
    "section": "",
    "text": "Ce tutoriel vise √† offrir une approche compl√©mentaire au guide d‚Äôutilisation des donn√©es du recensement au format Parquet publi√© sur https://ssphub.netlify.app pour accompagner la diffusion de celles-ci par l‚ÄôInsee.\nIl s‚Äôagit d‚Äôun tutoriel pr√©par√© pour l‚Äôatelier tuto@mate √† l‚ÄôEHESS le 5 novembre 2024. Ce tutoriel est exclusivement en R. Les slides de la pr√©sentation sont disponibles ci-dessous:\nIl propose des exemples vari√©s pour illustrer la simplicit√© d‚Äôusage du format Parquet. Parmi ceux-ci, √† partir du recensement de la population:\nA partir de la base permanent des √©quipements (BPE):"
  },
  {
    "objectID": "tuto/r.html#footnotes",
    "href": "tuto/r.html#footnotes",
    "title": "Utilisation du format Parquet avec  illustr√© √† partir de quelques exemples",
    "section": "Footnotes",
    "text": "Footnotes\n\nSi vous avez cl√¥n√© le d√©p√¥t disponible sur Github , un environnement virtuel renv vous permet de recr√©er la m√™me configuration logicielle que celle utilis√©e pour g√©n√©rer cette page. Pour cela, il suffit de faire renv::restore().‚Ü©Ô∏é\nPour en savoir plus sur ce projet, se rendre sur la documentation du projet.‚Ü©Ô∏é"
  },
  {
    "objectID": "slides/index.html#plan",
    "href": "slides/index.html#plan",
    "title": "Le format de donn√©es Parquet",
    "section": "Plan",
    "text": "Plan\n\nContexte\nPourquoi le format Parquet ?\nL‚Äô√©cosyst√®me Parquet\nD√©monstration"
  },
  {
    "objectID": "slides/index.html#le-recensement-de-la-population",
    "href": "slides/index.html#le-recensement-de-la-population",
    "title": "Le format de donn√©es Parquet",
    "section": "Le recensement de la population",
    "text": "Le recensement de la population\n\nMission historique de l‚ÄôInsee depuis 1946\n\nL‚ÄôInsee organise, les communes r√©alisent la collecte\n\n\n\n\nUne source d‚Äôutilit√© publique :\n\nPopulations l√©gales: dotations de l‚Äô√âtat aux communes, organisation des scrutins, √©quipements publics, etc.\nRecherche: caract√©ristiques socio-d√©mographiques, mobilit√©s‚Ä¶\n\n\n\n\n\n\n\n\nEnqu√™tes annuelles de recensement (EAR) depuis 2004\n\n\n\nPour une commune de moins de 10 000 habitants:\n\nCollecte exhaustive une fois tous les 5 ans.\n\nPour une commune de plus de 10 000 habitants:\n\nChaque ann√©e, 8% des logements sont recens√©s ;\nLe r√©sultat du recensement est calcul√© √† partir des 5 derni√®res ann√©es (=40% logements)\n\n\nDocumentation technique sur le recensement"
  },
  {
    "objectID": "slides/index.html#une-diffusion-sous-plusieurs-formes",
    "href": "slides/index.html#une-diffusion-sous-plusieurs-formes",
    "title": "Le format de donn√©es Parquet",
    "section": "Une diffusion sous plusieurs formes",
    "text": "Une diffusion sous plusieurs formes\n\nDiffusion sur insee.fr sous plusieurs formes:\n\nPages ‚Äúdynamiques‚Äù sur insee.fr\nExports d‚Äôagr√©gats depuis statistiques-locales.insee.fr/\nDes donn√©es, des cartes, des publications, etc..\n\n\n\n\nMais beaucoup de gestes manuels pour obtenir un seul agr√©gat\n\n\n\n\nUne information parfois difficile √† trouver sur le site de l‚ÄôInsee"
  },
  {
    "objectID": "slides/index.html#une-diffusion-sous-plusieurs-formes-1",
    "href": "slides/index.html#une-diffusion-sous-plusieurs-formes-1",
    "title": "Le format de donn√©es Parquet",
    "section": "Une diffusion sous plusieurs formes",
    "text": "Une diffusion sous plusieurs formes\n\nLes fichiers agr√©g√©s\n\n\n\nStructure type: une ligne par commune ou IRIS\n\n\n\nTaille de chaque fichier relativement raisonnable\n\nCSV g√©n√©ralement de quelques Mo, jusqu‚Äô√† 150 Mo"
  },
  {
    "objectID": "slides/index.html#une-diffusion-sous-plusieurs-formes-2",
    "href": "slides/index.html#une-diffusion-sous-plusieurs-formes-2",
    "title": "Le format de donn√©es Parquet",
    "section": "Une diffusion sous plusieurs formes",
    "text": "Une diffusion sous plusieurs formes\n\nLes micro-donn√©es anonymis√©es\n\n\nStructure type: une ligne par observation\n\nUn logement, un individu‚Ä¶\n\n\n\n\nPermet de construire d‚Äôautres croisements que ceux propos√©s sur insee.fr\n\n\n\n\n\n\n\n\n\nUn format destin√© √† des utilisateurs avanc√©s\n\n\n\nUne source riche mais des pr√©cautions d‚Äôemploi √† respecter:\n\nPond√©rations √† prendre en compte\nInterpr√©tation des petits effectifs‚Ä¶\n\nDemande une certaine expertise"
  },
  {
    "objectID": "slides/index.html#d√©fi",
    "href": "slides/index.html#d√©fi",
    "title": "Le format de donn√©es Parquet",
    "section": "D√©fi",
    "text": "D√©fi\n\nCe sont des fichiers tr√®s volumineux\n\nJusqu‚Äô√† 100 variables et 25 millions de lignes\nFichier CSV jusqu‚Äô√† 5 Go\n\n\n\n\nPour l‚ÄôInsee : complexes √† produire et valider avant diffusion\n\n\n\n\nPour l‚Äôutilisateur.trice : complexes √† t√©l√©charger, stocker et exploiter"
  },
  {
    "objectID": "slides/index.html#solution-historique",
    "href": "slides/index.html#solution-historique",
    "title": "Le format de donn√©es Parquet",
    "section": "Solution historique",
    "text": "Solution historique\n\nDiffusion zipp√©e (CSV) ou format DBase (format propri√©taire)\n\nD√©coupage en fichiers par grandes zones de r√©gions"
  },
  {
    "objectID": "slides/index.html#une-source-id√©ale-pour-innover-dans-la-diffusion",
    "href": "slides/index.html#une-source-id√©ale-pour-innover-dans-la-diffusion",
    "title": "Le format de donn√©es Parquet",
    "section": "Une source id√©ale pour innover dans la diffusion",
    "text": "Une source id√©ale pour innover dans la diffusion\n\nMont√©e en puissance du format Parquet pour les usages internes √† l‚ÄôInsee:\n\nPourquoi ne pas offrir le m√™me confort √† l‚Äôexterne ?\n\n\n\n\nUne demande d‚Äôutilisateurs.trices averti.e.s\n\nPar exemple Eric Mauvi√®re"
  },
  {
    "objectID": "slides/index.html#une-source-id√©ale-pour-innover-dans-la-diffusion-1",
    "href": "slides/index.html#une-source-id√©ale-pour-innover-dans-la-diffusion-1",
    "title": "Le format de donn√©es Parquet",
    "section": "Une source id√©ale pour innover dans la diffusion",
    "text": "Une source id√©ale pour innover dans la diffusion\n\nPublication en octobre 2023 des donn√©es et d‚Äôun guide d‚Äôutilisation"
  },
  {
    "objectID": "slides/index.html#une-source-id√©ale-pour-innover-dans-la-diffusion-2",
    "href": "slides/index.html#une-source-id√©ale-pour-innover-dans-la-diffusion-2",
    "title": "Le format de donn√©es Parquet",
    "section": "Une source id√©ale pour innover dans la diffusion",
    "text": "Une source id√©ale pour innover dans la diffusion\n\nUn accueil enthousiaste des utilisateurs.trices"
  },
  {
    "objectID": "slides/index.html#une-source-id√©ale-pour-innover-dans-la-diffusion-3",
    "href": "slides/index.html#une-source-id√©ale-pour-innover-dans-la-diffusion-3",
    "title": "Le format de donn√©es Parquet",
    "section": "Une source id√©ale pour innover dans la diffusion",
    "text": "Une source id√©ale pour innover dans la diffusion\n\nD‚Äôautres institutions l‚Äôutilisent maintenant pour leur diffusion\n\n\n\n\n\nStatistiques sur longue p√©riode des crimes et d√©lis"
  },
  {
    "objectID": "slides/index.html#parquet-cest-quoi",
    "href": "slides/index.html#parquet-cest-quoi",
    "title": "Le format de donn√©es Parquet",
    "section": "Parquet : c‚Äôest quoi ?",
    "text": "Parquet : c‚Äôest quoi ?\n\nUn format de donn√©es adapt√©‚Ä¶\n\nAux donn√©es volumineuses ;\nAux donn√©es complexes (exemple: 01004 pour le code commune d‚ÄôAmb√©rieu-en-Bugey)\n\n\n\n\nUn format de donn√©es opensource bien int√©gr√©:\n\nA l‚Äô√©cosyst√®me R, Python et Observable"
  },
  {
    "objectID": "slides/index.html#parquet-pourquoi",
    "href": "slides/index.html#parquet-pourquoi",
    "title": "Le format de donn√©es Parquet",
    "section": "Parquet : pourquoi ?",
    "text": "Parquet : pourquoi ?\n\nFormat l√©ger, tr√®s compress√©:\n\nEntre 5 et 20 fois plus l√©ger qu‚Äôun CSV\nPas de perte d‚Äôefficacit√© en lecture\n\n\n\n\n\n\n\n\n\n\nExemple: recensement de la population\n\n\n\n20 millions de lignes, 88 colonnes\n\nCSV: &gt; 5Go\nParquet: 508Mo\n\n\n\n\n\n\n\n\n\n\n\n\nExemple: statistiques de la d√©linquance\n\n\n\n3.5 millions de lignes:\n\nCSV: 400Mo\nParquet: 11Mo"
  },
  {
    "objectID": "slides/index.html#le-csv-en-apparence-pratique",
    "href": "slides/index.html#le-csv-en-apparence-pratique",
    "title": "Le format de donn√©es Parquet",
    "section": "Le CSV: en apparence pratique",
    "text": "Le CSV: en apparence pratique\n\n\n\n\nFacile √† lire, facile √† ouvrir, mais\n\n\n\n\n\n\n\n\n\n\nProbl√®me: il faut scanner tout le fichier pour avoir une seule colonne\n\n\n\nLent en lecture, pas compress√©\nProbl√®me pour deviner le type d‚Äôune variable\nM√™me si on ne veut que certaines colonnes, il faut lire tout le fichier"
  },
  {
    "objectID": "slides/index.html#parquet-un-format-orient√©-colonne",
    "href": "slides/index.html#parquet-un-format-orient√©-colonne",
    "title": "Le format de donn√©es Parquet",
    "section": "Parquet: un format orient√© colonne",
    "text": "Parquet: un format orient√© colonne\n\n\nPlus pratique pour n‚Äôouvrir qu‚Äôun sous-ensemble de variables ;\n\nPas besoin de scanner tout le fichier pour √©tudier quelques variables ;"
  },
  {
    "objectID": "slides/index.html#parquet-quels-avantages",
    "href": "slides/index.html#parquet-quels-avantages",
    "title": "Le format de donn√©es Parquet",
    "section": "Parquet : quels avantages ?",
    "text": "Parquet : quels avantages ?\n\n\nFormat libre, open source, et ind√©pendant du langage ;\n\n\n\nPlus de confort pour les utilisateurs:\n\nDes requ√™tes plus rapides et efficaces (seulement les donn√©es n√©cessaires sont lues)\nDes donn√©es conformes √† la mise √† disposition par le producteur (plus de probl√®me de codes communes‚Ä¶)"
  },
  {
    "objectID": "slides/index.html#parquet-quels-usages",
    "href": "slides/index.html#parquet-quels-usages",
    "title": "Le format de donn√©es Parquet",
    "section": "Parquet : quels usages ?",
    "text": "Parquet : quels usages ?\n\nFormat privil√©gi√© pour la mise √† disposition de donn√©es internes √† l‚ÄôInsee:\n\nMoins d‚Äôasym√©tries entre utilisateurs et producteurs.\n\n\n\n\n\n\n\n\nPremi√®res diffusions √† l‚Äôexterne\n\n\n\nBureaux de votes du r√©pertoire √©lectoral unique (REU):\nRecensement de la population (RP)\nPlus r√©cemment, la base permanente des √©quipements (BPE)"
  },
  {
    "objectID": "slides/index.html#parquet-quels-usages-1",
    "href": "slides/index.html#parquet-quels-usages-1",
    "title": "Le format de donn√©es Parquet",
    "section": "Parquet : quels usages ?",
    "text": "Parquet : quels usages ?\n\nviewof source = Inputs.radio([\n  \"Recensement\", \"R√©pertoire √©lectoral unique\"\n], {value: \"Recensement\"})\n\n\n\n\n\n\n\n\nInputs.table(data)\n\n\n\n\n\n\n\ndata = (source == \"Recensement\") ? rp : reu\n\n\n\n\n\n\n\ndb = DuckDBClient.of({})\n\nrp = db.query(\n  \"SELECT AGED, CATL, SEXE, CANTVILLE, IPONDI FROM read_parquet('https://static.data.gouv.fr/resources/recensement-de-la-population-fichiers-detail-individus-localises-au-canton-ou-ville-2020-1/20231023-122841/fd-indcvi-2020.parquet') LIMIT 5\"\n)\nreu = db.query(\n  \"SELECT geo_adresse, id_brut_bv_reu FROM read_parquet('https://static.data.gouv.fr/resources/bureaux-de-vote-et-adresses-de-leurs-electeurs/20230626-135723/table-adresses-reu.parquet') LIMIT 5\"\n)"
  },
  {
    "objectID": "slides/index.html#pourquoi-duckdb",
    "href": "slides/index.html#pourquoi-duckdb",
    "title": "Le format de donn√©es Parquet",
    "section": "Pourquoi DuckDB ?",
    "text": "Pourquoi DuckDB ?\n\nParquet ne r√©sout pas tout:\n\nL‚Äôespace disque est optimis√©\nLes donn√©es d√©compress√©es doivent passer en RAM\n\n\n‚ùìÔ∏è Comment analyser ces donn√©es sur un PC avec 8 GB de RAM ?"
  },
  {
    "objectID": "slides/index.html#pourquoi-duckdb-1",
    "href": "slides/index.html#pourquoi-duckdb-1",
    "title": "Le format de donn√©es Parquet",
    "section": "Pourquoi DuckDB ?",
    "text": "Pourquoi DuckDB ?"
  },
  {
    "objectID": "slides/index.html#pourquoi-duckdb-2",
    "href": "slides/index.html#pourquoi-duckdb-2",
    "title": "Le format de donn√©es Parquet",
    "section": "Pourquoi DuckDB ?",
    "text": "Pourquoi DuckDB ?\n\n\n\nDuckDB est un utilitaire open source\n\nUn logiciel en ligne de commande tout simple (20Mo)‚Ä¶\nDes librairies ,  et Observable pour simplifier l‚Äôusage\nRequ√™tes SQL mais aussi int√©gration tidyverse pour \n\n\n\n\n\n\n\n\n\nDuckDB est tr√®s efficace:\n\nMoteur SQL enrichi avec des fonctions tr√®s pratiques pour l‚Äôanalyse\nOptimisations automatiques\nVisualisations sans ex√©cuter sur toute la base\n\n\n\n\nüí° Les avantages du monde des bases de donn√©es sans ses inconv√©nients"
  },
  {
    "objectID": "slides/index.html#reproductibilit√©-des-exemples",
    "href": "slides/index.html#reproductibilit√©-des-exemples",
    "title": "Le format de donn√©es Parquet",
    "section": "Reproductibilit√© des exemples",
    "text": "Reproductibilit√© des exemples\n\n\n\nPlateforme de data science d√©velopp√©e par l‚ÄôInsee\n\nEnvironnements standardis√©s , \nAccessible aux chercheurs.euses pour l‚Äôenseignement üòâ\n\n\n\n\nEnvironnements pr√©configur√©s lan√ßables en 1 clic:\n\n\n\n\n\n\n\n\n\n\n\n\n\nAstuce\n\n\nSi vous avez un compte, n‚Äôh√©sitez pas √† essayer les exemples pr√©sent√©s en live !"
  },
  {
    "objectID": "slides/index.html#id√©es",
    "href": "slides/index.html#id√©es",
    "title": "Le format de donn√©es Parquet",
    "section": "Id√©es",
    "text": "Id√©es\n\nTuto ssphub\nFaire une carte des r√©sidences secondaires en France\nModes de transport\nDistribution par √¢ge\n\n\n\n\nAtelier tuto@mate (retour √† la page principale de ce site)"
  },
  {
    "objectID": "tuto/observablehq.html",
    "href": "tuto/observablehq.html",
    "title": "Utilisation du format Parquet avec Observable illustr√© √† partir de quelques exemples",
    "section": "",
    "text": "Page observablehq"
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Atelier tuto@mate sur le format Parquet",
    "section": "",
    "text": "Un ensemble de ressources pour pr√©senter les enjeux de l‚Äôutilisation du format Parquet illustr√© √† partir des donn√©es du recensement.\n\n\n\n\n\n\n\n\n\n\nLe format de donn√©es Parquet\n\n\nSlides pr√©sentant les enjeux de l‚Äôutilisation du format Parquet et l‚Äô√©cosyst√®me associ√©\n\n\n\nLino Galiana\n\n\nNov 5, 2024\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nUtilisation du format Parquet avec  illustr√© √† partir de quelques exemples\n\n\nTutoriel R\n\n\n\nLino Galiana\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nUtilisation du format Parquet avec Python illustr√© √† partir de quelques exemples\n\n\nTutoriel Python\n\n\n\nLino Galiana\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nUtilisation du format Parquet avec Observable illustr√© √† partir de quelques exemples\n\n\nTutoriel Observable\n\n\n\nLino Galiana\n\n\n\n\n\n\n\n\nNo matching items\n\n\nReplay de la pr√©sentation:"
  },
  {
    "objectID": "tuto/python.html",
    "href": "tuto/python.html",
    "title": "Utilisation du format Parquet avec Python illustr√© √† partir de quelques exemples",
    "section": "",
    "text": "Ce tutoriel n‚Äôest pas encore fini, il sera progressivement enrichi\nCe tutoriel vise √† offrir une approche compl√©mentaire au guide d‚Äôutilisation des donn√©es du recensement au format Parquet publi√© sur https://ssphub.netlify.app pour accompagner la diffusion de celles-ci par l‚ÄôInsee.\nIl s‚Äôagit d‚Äôun tutoriel pr√©par√© pour l‚Äôatelier tuto@mate √† l‚ÄôEHESS le 5 novembre 2024. Ce tutoriel est exclusivement en R. Les slides de la pr√©sentation sont disponibles ci-dessous:\nD√©rouler les slides ci-dessous ou cliquer ici pour afficher les slides en plein √©cran.\nIl propose des exemples vari√©s pour illustrer la simplicit√© d‚Äôusage du format Parquet. Parmi ceux-ci, √† partir du recensement de la population:"
  },
  {
    "objectID": "tuto/python.html#requ√™tes-sur-les-colonnes-select",
    "href": "tuto/python.html#requ√™tes-sur-les-colonnes-select",
    "title": "Utilisation du format Parquet avec Python illustr√© √† partir de quelques exemples",
    "section": "Requ√™tes sur les colonnes (SELECT)",
    "text": "Requ√™tes sur les colonnes (SELECT)\nL‚Äôune des forces du format Parquet est de simplifier l‚Äôimport de fichiers volumineux qui ne comportent que quelques colonnes nous int√©ressant. Par exemple, la table des individus comporte 88 colonnes, il est peu probable qu‚Äôune seule analyse s‚Äôint√©resse √† toutes celles-ci (ou elle risque d‚Äô√™tre fort indigeste).\n\nComme cela est illustr√© dans ?@tip-optimisation-duckdb, la diff√©rence de volum√©trie entre un fichier non filtr√© et un fichier filtr√© est importante.\n\nquery = (\n  f\"FROM read_parquet(\\\"{filename_table_individu}\\\") \"\n  \"SELECT IPONDI AS poids, AGED, VOIT \"\n  \"LIMIT 10\"\n)\nduckdb.sql(query).to_df()\n\n\n\n\n\n\n\nComprendre l‚Äôoptimisation permise par Parquet et DuckDB\n\n\n\n\n\nPour r√©duire la volum√©trie des donn√©es import√©es, il est possible de mettre en oeuvre deux strat√©gies:\n\nN‚Äôimporter qu‚Äôun nombre limit√© de colonnes\nN‚Äôimporter qu‚Äôun nombre limit√© de lignes\n\nComme cela a √©t√© √©voqu√© dans les slides, le format Parquet est particuli√®rement optimis√© pour le premier besoin. C‚Äôest donc g√©n√©ralement la premi√®re optimisation mise en oeuvre. Pour s‚Äôen convaincre on peut regarder la taille des donn√©es import√©es dans deux cas:\n\nOn utilise beaucoup de lignes mais peu de colonnes\nOn utilise beaucoup de colonnes mais peu de lignes\n\nPour cela, nous utilisons la fonction SQL EXPLAIN ANALYZE disponible dans duckdb. Elle d√©compose le plan d‚Äôex√©cution de duckdb, ce qui nous permettra de comprendre la strat√©gie d‚Äôoptimisation. Elle permet aussi de conna√Ætre le volume de donn√©es import√©es lorsqu‚Äôon r√©cup√®re un fichier d‚Äôinternet. En effet, duckdb est malin: plut√¥t que de t√©l√©charger un fichier entier pour n‚Äôen lire qu‚Äôune partie, la librairie est capable de n‚Äôimporter que les blocs du fichier qui l‚Äôint√©resse.\nCeci n√©cessite l‚Äôutilisation de l‚Äôextension httpfs (un peu l‚Äô√©quivalent des library de R en duckdb). Elle s‚Äôinstalle et s‚Äôutilise de la mani√®re suivante\n\nduckdb.sql(\"INSTALL httpfs; LOAD httpfs;\")\n\nDemandons √† DuckDB d‚Äôex√©cuter la requ√™te ‚Äúbeaucoup de colonnes, pas beaucoup de lignes‚Äù et regardons le plan d‚Äôex√©cution et les informations donn√©es par DuckDB:\n\n\nVoir le plan : ‚Äúbeaucoup de colonnes, pas beaucoup de lignes‚Äù\n\n\nurl_table_logement = files_to_download.get(\"logements\").get(\"url\")\nurl_table_individu = files_to_download.get(\"individus\").get(\"url\")\n\nplan = duckdb.query(\nf\"\"\"\nEXPLAIN ANALYZE\nFROM read_parquet(\"{url_table_logement}\")\nSELECT *\nLIMIT 5\n\"\"\"\n) \n\n\nprint(\n  plan.to_df()['explain_value'].iloc[0]\n)\n\n\n\n\nVoir le plan : ‚Äúpas de colonnes, beaucoup de lignes‚Äù\n\n\nplan = duckdb.sql(\n  f\"\"\"\n  EXPLAIN ANALYZE\n  SELECT IPONDI AS poids, AGED, VOIT FROM read_parquet(\"{url_table_individu}\") LIMIT 10000\n  \"\"\"\n)\n\n\nprint(\n  plan.to_df()['explain_value'].iloc[0]\n)\n\n\nLa comparaison de ces plans d‚Äôex√©cution montre l‚Äôint√©r√™t de faire un filtre sur les colonnes : les besoins computationnels sont drastiquement diminu√©s. Le filtre sur les lignes n‚Äôarrive que dans un second temps, une fois les colonnes s√©lectionn√©es.\nPourquoi seulement un rapport de 1 √† 4 entre le poids des deux fichiers ? C‚Äôest parce que nos requ√™tes comportent toute deux la variable IPONDI (les poids √† utiliser pour extrapoler l‚Äô√©chantillon √† la population) qui est √† haute pr√©cision l√† o√π beaucoup d‚Äôautres colonnes comportent un nombre r√©duit de modalit√©s et sont donc peu volumineuses.\n\n\n\nDuckDB propose √©galement des fonctionnalit√©s pour extraire des colonnes √† travers des expressions r√©guli√®res. Cette approche est √©galement possible avec le tidyverse\n\nduckdb.sql(\n  f\"\"\"\n    FROM read_parquet(\\\"{filename_table_individu}\\\")\n    SELECT IPONDI AS poids, COLUMNS('.*AGE.*')\n    LIMIT 10\n  \"\"\"\n).to_df()"
  },
  {
    "objectID": "tuto/python.html#requ√™tes-sur-les-lignes-where",
    "href": "tuto/python.html#requ√™tes-sur-les-lignes-where",
    "title": "Utilisation du format Parquet avec Python illustr√© √† partir de quelques exemples",
    "section": "Requ√™tes sur les lignes (WHERE)",
    "text": "Requ√™tes sur les lignes (WHERE)\n\nduckdb.sql(\n    f\"\"\"\n    FROM read_parquet(\"{filename_table_individu}\")\n    SELECT IPONDI, AGED, DEPT\n    WHERE DEPT IN ('11', '31', '34')\n    LIMIT 10\n    \"\"\"\n).to_df()\n\nLes filtres sur les observations peuvent √™tre faits √† partir de crit√®res sur plusieurs colonnes. Par exemple, pour ne conserver que les observations de la ville de Nice o√π la date d‚Äôemm√©nagement est post√©rieure √† 2020, la requ√™te suivante peut √™tre utilis√©e :\n\nduckdb.sql(\n    f\"\"\"\n    FROM read_parquet(\"{filename_table_logement}\")\n    SELECT *\n    WHERE COMMUNE = '06088' AND AEMM &gt; 2020\n    LIMIT 10\n    \"\"\"\n).to_df()"
  },
  {
    "objectID": "tuto/python.html#exemples-sans-groupes",
    "href": "tuto/python.html#exemples-sans-groupes",
    "title": "Utilisation du format Parquet avec Python illustr√© √† partir de quelques exemples",
    "section": "Exemples sans groupes",
    "text": "Exemples sans groupes\nLa fonction DISTINCT appliqu√©e √† la variable ARM permet d‚Äôextraire la liste des codes arrondissements pr√©sents dans la base de donn√©es.\n\nquery = f\"\"\"\nFROM read_parquet('{filename_table_logement}')\nSELECT DISTINCT ARM\nWHERE NOT ARM LIKE '%ZZZZZ%'\nORDER BY ARM\n\"\"\"\n\nresult = \", \".join(duckdb.sql(query).to_df()[\"ARM\"])\n\nIl est possible d‚Äôextraire des statistiques beaucoup plus raffin√©es par le biais d‚Äôune requ√™te SQL plus complexe. Par exemple pour calculer le nombre d‚Äôhabitants de Toulouse qui ont chang√© de logement en un an:\n\nquery = f\"\"\"\nFROM read_parquet(\"{filename_table_logement}\")\nSELECT CAST(SUM(IPONDL * CAST(INPER AS INT)) AS INT) \nAS habitants_toulouse_demenagement\nWHERE COMMUNE = '31555' \nAND IRANM NOT IN ('1', 'Z') \nAND INPER != 'Y'\n\"\"\"\n\nduckdb.sql(query).to_df()"
  },
  {
    "objectID": "tuto/python.html#statistiques-par-groupe",
    "href": "tuto/python.html#statistiques-par-groupe",
    "title": "Utilisation du format Parquet avec Python illustr√© √† partir de quelques exemples",
    "section": "Statistiques par groupe",
    "text": "Statistiques par groupe\nSQL et dplyr permettent d‚Äôaller loin dans la finesse des statistiques descriptives mises en oeuvre. Cela sera illustr√© √† l‚Äôaide de plusieurs exemples r√©fl√©tant des statistiques pouvant √™tre construites gr√¢ce √† ces donn√©es d√©taill√©es.\n\nExemple 1: pyramide des √¢ges dans l‚ÄôAude, l‚ÄôH√©rault et le Gard\nLe premier exemple est un comptage sur trois d√©partements. Il illustre la d√©marche suivante:\n\nOn se restreint aux observations d‚Äôint√©r√™t (ici 3 d√©partements)\nOn applique la fonction summarise pour calculer une statistique par groupe, en l‚Äôoccurrence la somme des pond√©rations\nOn retravaille les donn√©es\n\nEnsuite, une fois que nos donn√©es sont r√©cup√©r√©es dans R, on peut faire la figure avec ggplot\n\n\n\n\nListing¬†1: Pyramide des √¢ges dans l‚ÄôAude, l‚ÄôH√©rault et le Gard\n\n\npyramide_ages = duckdb.sql(\n        f\"\"\"\n        FROM read_parquet(\"{filename_table_individu}\")\n        SELECT AGED, DEPT AS departement, SUM(IPONDI) AS individus\n        WHERE DEPT IN ('11', '31', '34')\n        GROUP BY AGED, DEPT\n        ORDER BY DEPT, AGED\n        \"\"\"\n    ).to_df()\n\n# Create the plot\nplot = (\n    ggplot(pyramide_ages, aes(x='AGED', y='individus'))\n    + geom_bar(aes(fill='departement'), stat=\"identity\")\n    + geom_vline(xintercept=18, color=\"grey\", linetype=\"dashed\")\n    + facet_wrap('~departement', scales=\"free_y\", nrow=3)\n    + theme_minimal()\n    + labs(y=\"Individus recens√©s\", x=\"√Çge\")\n)\n\nplot\n\n\n\n\n\n\nExemple 2: r√©partition des plus de 60 ans par d√©partement\nL‚Äôobjectif de ce deuxi√®me exemple est d‚Äôillustrer la construction d‚Äôune statistique un peu plus complexe et la mani√®re de projeter celle-ci sur une carte.\nPour avoir la r√©partition des plus de 60 ans par d√©partement, quelques lignes de dplyr suffisent:\n\nimport pandas as pd\nimport duckdb\n\n# Query to calculate total population and population over 60\npart_population_60_plus = duckdb.sql(\n    f\"\"\"\n    FROM read_parquet(\"{filename_table_individu}\")\n    SELECT \n        DEPT,\n        SUM(IPONDI) AS total_population,\n        SUM(CASE WHEN AGED &gt; 60 THEN IPONDI ELSE 0 END) AS population_60_plus\n    GROUP BY DEPT\n    \"\"\"\n).to_df()\n\n# Calculate percentage of population over 60\npart_population_60_plus['pourcentage_60_plus'] = (\n    part_population_60_plus['population_60_plus'] / part_population_60_plus['total_population'] * 100\n)\n\n# Display the result\npart_population_60_plus\n\nIl ne reste plus qu‚Äô√† projeter ceci sur une carte. Pour cela, un join √† notre fond de carte suffit. Comme les donn√©es sont agr√©g√©es et d√©j√† dans R, il n‚Äôy a rien de sp√©cifique √† duckdb ici.\n\n\nAssociation de part_population_60_plus au fond de carte des d√©partements\n# Joindre les donn√©es au fond de carte des d√©partements\n\ndepartements_60_plus_gpd = (\n  departements\n    .merge(\n      part_population_60_plus,\n      left_on = \"INSEE_DEP\",\n      right_on = \"DEPT\"\n    )\n)\n\n\nFinalement, il ne reste plus qu‚Äô√† produire la carte:\n\ndepartements_60_plus_gpd['pourcentage_60_plus_d'] = pd.qcut(\n  departements_60_plus_gpd['pourcentage_60_plus'],\n  q=4\n)\n\n\n(\n  ggplot(departements_60_plus_gpd) +\n    geom_map(aes(fill = \"pourcentage_60_plus_d\")) + \n    scale_fill_brewer(palette = \"PuBuGn\", direction = 1) + \n    theme_void() + \n    labs(\n        title = \"Part des personnes de plus de 60 ans par d√©partement\",\n        caption = \"Source: Insee, Fichiers d√©tails du recensement de la population\",\n        fill = \"Part (%)\"\n    )\n)\n\nSi on pr√©f√®re repr√©senter ceci sous forme de tableau, on peut utiliser le package great tables. Cela n√©cessite quelques manipulations de donn√©es en amont.\n\npart_population_60_plus_dep = part_population_60_plus.merge(\n  departements.loc[:, [\"INSEE_DEP\", \"LIBELLE_DEPARTEMENT\"]],\n  left_on = \"DEPT\",\n  right_on = \"INSEE_DEP\"\n)\npart_population_60_plus_dep[\"departement\"] = part_population_60_plus_dep[\"LIBELLE_DEPARTEMENT\"] + \" (\" + part_population_60_plus_dep[\"DEPT\"]  + \")\"\n\npart_population_60_plus_dep = part_population_60_plus_dep.sort_values(\"pourcentage_60_plus\", ascending=False).head(10)\n\n\nfrom great_tables import *\n(\n  GT(\n    part_population_60_plus_dep.loc[\n      :, ['departement', 'total_population', 'population_60_plus', 'pourcentage_60_plus']\n    ]\n  )\n  .fmt_number(columns=[\n    \"total_population\", \"population_60_plus\"\n  ], compact=True)\n  .fmt_percent(\"pourcentage_60_plus\", scale_values = False)\n  .fmt_nanoplot(columns=\"pourcentage_60_plus\", plot_type=\"bar\")\n)\n\n\n\nExemple 3: part des r√©sidences secondaires et des logements vacants\nIl est tout √† fait possible de faire des √©tapes ant√©rieures de pr√©paration de donn√©es, notamment de cr√©ation de variables avec mutate.\nL‚Äôexemple suivant illustre la pr√©paration de donn√©es avant la construction de statistiques descriptives de la mani√®re suivante:\n\nCr√©ation d‚Äôune variable de d√©partement √† partir du code commune\nD√©compte des logements par d√©partement\n\nSuite du tutoriel √† venir\n\nimport shutil\nshutil.rmtree(\"data\")"
  },
  {
    "objectID": "tuto/python.html#footnotes",
    "href": "tuto/python.html#footnotes",
    "title": "Utilisation du format Parquet avec Python illustr√© √† partir de quelques exemples",
    "section": "Footnotes",
    "text": "Footnotes\n\n\nPour en savoir plus sur ce projet, se rendre sur la documentation du projet.‚Ü©Ô∏é"
  }
]